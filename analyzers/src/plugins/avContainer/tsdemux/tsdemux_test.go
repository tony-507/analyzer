package tsdemux

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/tony-507/analyzers/src/common"
)

func TestDemuxDeliverUnit(t *testing.T) {
	m_pMux := TsDemuxer{name: "dummy"}
	m_parameter := "{\"Mode\": \"_DEMUX_DUMMY\"}"
	m_pMux.setParameter(m_parameter)

	m_pMux.setCallback(func(s string, reqType common.WORKER_REQUEST, obj interface{}) {
		expected := common.MakeReqUnit("dummy", common.FETCH_REQUEST)
		assert.Equal(t, expected, obj, "Unit not equal")
	})

	for i := 0; i < 2; i++ {
		dummy := common.MakeIOUnit(i, 1, 0)
		m_pMux.deliverUnit(dummy)
	}
}

func TestDemuxPipeProcessing(t *testing.T) {
	dummyPAT := []byte{0x47, 0x40, 0x00, 0x14, 0x00, 0x00, 0xB0, 0x0D, 0x11, 0x11, 0xC1,
		0x00, 0x00, 0x00, 0x0A, 0xE1, 0x02, 0xAA, 0x4A, 0xE2, 0xD2}

	control := getControl()
	impl := getDemuxPipe(control, "Dummy")

	impl.processUnit(dummyPAT, 0)

	programMap := make(map[int]int, 0)
	programMap[10] = 258

	assert.Equal(t, programMap, impl.programRecords, "PAT not match")

	dummyPMT := []byte{0x47, 0x41, 0x02, 0x14, 0x00, 0x02, 0xb0, 0x1d, 0x00, 0x0a, 0xc1,
		0x00, 0x00, 0xe0, 0x20, 0xf0, 0x00, 0x02, 0xe0, 0x20,
		0xf0, 0x00, 0x04, 0xe0, 0x21, 0xf0, 0x06, 0x0a, 0x04,
		0x65, 0x6e, 0x67, 0x00, 0x75, 0xff, 0x59, 0x3a}

	impl.processUnit(dummyPMT, 0)

	streamRecords := make(map[int]int, 0)
	streamRecords[32] = 2
	streamRecords[33] = 4

	assert.Equal(t, streamRecords, impl.streamRecords, "PMT not match")

	unknownPkt := []byte{0x47, 0x40, 0x51, 0x11, 0xff}

	impl.processUnit(unknownPkt, 0)

	assert.Equal(t, 2, impl.control.pCnt, "Process count not match")
}

func tsDemuxPidStatusTest(t *testing.T) {
	dummyPAT := []byte{0x47, 0x40, 0x00, 0x14, 0x00, 0x00, 0xB0, 0x0D, 0x11, 0x11, 0xC1,
		0x00, 0x00, 0x00, 0x0A, 0xE1, 0x02, 0xAA, 0x4A, 0xE2, 0xD2}

	control := getControl()
	impl := getDemuxPipe(control, "Dummy")

	impl.processUnit(dummyPAT, 0)
	assert.Equal(t, 2, len(impl.control.StatusList), "Expect 2 status units: PAT and PMT")
	control.StatusList = make([]common.CmUnit, 0)

	dummyPMT := []byte{0x47, 0x41, 0x02, 0x14, 0x00, 0x02, 0xb0, 0x1d, 0x00, 0x0a, 0xc1,
		0x00, 0x00, 0xe0, 0x20, 0xf0, 0x00, 0x02, 0xe0, 0x20,
		0xf0, 0x00, 0x04, 0xe0, 0x21, 0xf0, 0x06, 0x0a, 0x04,
		0x65, 0x6e, 0x67, 0x00, 0x75, 0xff, 0x59, 0x3a}

	impl.processUnit(dummyPMT, 0)

	assert.Equal(t, 2, len(impl.control.StatusList), "Expect 2 status units: video and audio")
}

func TestMultipleTsPacketPsi(t *testing.T) {
	pmt1 := []byte{0x47, 0x41, 0xE0, 0x1F, 0x00, 0x02, 0xB0, 0xB9, 0x00, 0x0A, 0xC1, 0x00, 0x00, 0xE0, 0x20, 0xF0,
		0x06, 0x05, 0x04, 0x43, 0x55, 0x45, 0x49, 0x1B, 0xE0, 0x20, 0xF0, 0x16, 0x41, 0x00, 0x43, 0x00,
		0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x43, 0x00, 0x12, 0x00, 0x45, 0x00, 0x66, 0x00,
		0x41, 0x00, 0x0F, 0xE0, 0x21, 0xF0, 0x28, 0xDD, 0x09, 0x48, 0x41, 0x52, 0x01, 0x01, 0x00, 0x01,
		0x77, 0x00, 0x0A, 0x04, 0x65, 0x6E, 0x67, 0x00, 0x41, 0x00, 0x43, 0x00, 0x41, 0x00, 0x43, 0x00,
		0x41, 0x00, 0x43, 0x00, 0x41, 0x00, 0x79, 0x00, 0x41, 0x00, 0x43, 0x00, 0x1C, 0x01, 0x58, 0x86,
		0xE0, 0x23, 0xF0, 0x06, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x86, 0xE0, 0x24, 0xF0, 0x06, 0x41,
		0x00, 0x41, 0x00, 0x41, 0x00, 0x86, 0xE0, 0x25, 0xF0, 0x06, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00,
		0x86, 0xE0, 0x26, 0xF0, 0x08, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x86, 0xE0, 0x27,
		0xF0, 0x06, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x86, 0xE0, 0x28, 0xF0, 0x06, 0x41, 0x00, 0x41,
		0x00, 0x41, 0x00, 0x86, 0xE0, 0x29, 0xF0, 0x06, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x86, 0xE0,
		0x30, 0xF0, 0x0A, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41}
	pmt2 := []byte{0x47, 0x01, 0xE0, 0x10, 0x00, 0x2E, 0x06, 0x44, 0x2E}

	control := getControl()
	impl := getDemuxPipe(control, "Dummy")

	impl.programRecords[10] = 480
	impl.processUnit(pmt1, 0)

	assert.Equal(t, true, impl.dataStructs[480] != nil, "non-terminating PMT should be stored")

	impl.processUnit(pmt2, 1)

	assert.Equal(t, true, impl.dataStructs[480] == nil, "PMT should be null now")

	expected := make(map[int]int, 0)
	expected[32] = 27
	expected[33] = 15
	expected[35] = 134
	expected[36] = 134
	expected[37] = 134
	expected[38] = 134
	expected[39] = 134
	expected[40] = 134
	expected[41] = 134
	expected[48] = 134
	assert.Equal(t, expected, impl.streamRecords, "PMT stream mapping not match")
}
